<html>
<head>
<title>GPTL usage example 7: Using handle versions of GPTLstart() and GPTLstop()</title>
<meta name="example" content="MPI profile">
<meta name="Keywords" content="pmpi","mpi","gptl","papi","call tree","profile","timing","performance analysis">
<meta name="Author" content="Jim Rosinski">
</head>
<body bgcolor="peachpuff">

<hr />
<a href="example6.html"><img border="0" src="btn_previous.gif"
				  width="100" height="20" alt="Example 6"
				  /></a> 
<a href="gptl_homepage.html"><img border="0" src="btn_next.gif"
			     width="100" height="20" alt="GPTL home page" /></a>

<br />

<h2>Example 7: Using handle versions of GPTLstart() and GPTLstop()</h2>
This is a Fortran code which uses newly implemented functions <b>GPTLstart_handle()</b>
and <b>GPTLstop_handle()</b>. The purpose of these functions is to lower GPTL
overhead by maintaining in user-provided space the address of the region of
interest. Since the "handle" is used internally as a pointer, in Fortran we
must allocate at least 8 bytes of storage for it. On initial
invocation, a zero input value of "handle" is a flag which tells GPTL to 
overwrite its contents with the address of the timer for later use. 
<p>
When called from within a threaded region, each thread must have a unique copy of
the handle variable, since GPTL maintains separate storage for timers which are invoked
from within threaded regions. Honestly, it is probably not worth the bother
of maintaining thread-specific handles when timing threaded regions. Just use
<b>GPTLstart()</b> and <b>GPTLstop()</b> for these situations. These
functions can be freely mixed with the _handle versions, as shown in the
example below.

<p>
<b><em>handle.F90:</em></b>
<pre>
<div style="background-color:white;">
program handle
  use gptl

  implicit none

  integer(8) :: do_i      ! handle used by gptlstart_handle() and gptlstop_handle()
  integer :: i
  integer :: ret

  ret = gptlinitialize () ! Initialize GPTL
  do_i = 0                ! Input value of 0 tells GPTL to generate handle for later use

  do i=1,1000000
    ret = gptlstart_handle ('do_i', do_i)   ! start a timer

! "do_i" is now set, generated by GPTL because the input value of do_i was zero. 
! All calls from now on to gptlstart_handle and gptlstop_handle will use the handle 
! rather than the character string (1st arg).
!
! IMPORTANT: GPTL does NOT check that the handle argument points to a timer matching
! the input character string argument! It could do this, but that defeats the point of 
! these functions, which is speed.

    ret = gptlstop_handle ('do_i', do_i)    ! stop the timer

! OK to mix _handle calls with their non-handle equivalents. The calls below will be slower
! though, because GPTL must look up the location of the region in its internal table.

    ret = gptlstart ('do_i')                ! start the same timer as above
    ret = gptlstop ('do_i')                 ! stop the same timer as above
  end do

  ret = gptlpr_file ('timing')              ! print the results
end program handle

</div>
</pre>
Now compile and run:
<pre>
<div>
% mpif90 -o handle handle.F90 -L.. -lgptl
% ./handle
</div>
</pre>

Here's the important output from the file named "timing" that got created:
<pre>
<div style="background-color:white;">

Stats for thread 0:
        Called  Recurse Wallclock max       min       UTR_Overhead  
  do_i   2.0e+06    -       0.137     0.000     0.000         0.240 
</div>
</pre>
<h3>Explanation of the above output</h3>
Only a single region named "do_i" was timed, and there were 2 million
invocations. The 2 million figure shows that the same region was being timed
for both the calls to <b>GPTLstart()/GPTLstop()</b> and
<b>GPTLstart_handle()/GPTLstop_handle()</b>. The _handle calls required
significantly less overhead, because GPTL was told the address of the region
rather than having to use its internal lookup procedure.
<hr />
<a href="example6.html"><img border="0" src="btn_previous.gif"
				  width="100" height="20" alt="Example 6"
				  /></a> 
<a href="gptl_homepage.html"><img border="0" src="btn_next.gif"
			     width="100" height="20" alt="GPTL home page" /></a>

<br />

</html>
